import{d as ue,u as ce,r as o,v as de,b as me,x as fe,c as p,a as s,j as W,w as y,z as M,e as q,T as U,f as D,y as P,G as pe,t as R,F as ve,i as xe,N as F,A as we,B as he,C as ye,X as H,s as r,Y as J,Z as ge,W as be,$ as ke,a0 as Ce,o as c,a1 as Pe,a2 as Se,_ as _e}from"./index-B-8m7vOr.js";const Le={key:0,class:"px-3 pt-2 pb-3 border-b border-white/10"},Te={class:"flex items-center gap-2 min-w-0"},Me={class:"flex flex-col min-w-0 text-left"},$e={class:"text-sm font-medium text-white truncate"},Ee={class:"max-h-[200px] overflow-y-auto"},Ne=["onClick"],Re={class:"text-sm truncate"},ze={key:0,class:"px-4 py-3 text-sm text-white/40"},Be={class:"text-sm font-medium"},je={key:0,class:"fixed inset-0 z-[300] flex items-center justify-center p-4"},Ae={class:"relative bg-[#282828] rounded-lg p-6 w-full max-w-md shadow-2xl"},Ie={class:"flex justify-end gap-3 mt-6"},Oe=["disabled"],Ve=ue({__name:"SongMenu",props:{song:{},buttonClass:{}},emits:["action"],setup(z,{emit:K}){const a=z,g=K,Q=ce(),b=o(null),$=o(null),B=o(null),k=o(!1),f=o(!1),C=o(!1),h=o(""),v=o([]),x=o(!1),j=o({top:"0px",left:"0px"});let d=null;const S=o(!1);let u=null;const _=o("right"),m=o(null),L=t=>{S.value=t.matches},E=de(()=>m.value&&v.value.find(e=>{var l;return e.id===((l=m.value)==null?void 0:l.id)})||null),A=async()=>{var T;await H();const t=(T=B.value)==null?void 0:T.getBoundingClientRect();if(!t)return;const e=200,l=12,n=window.innerWidth-t.right,i=t.left;n<e+l&&i>=e+l?_.value="left":n>=e+l?_.value="right":_.value=i>n?"left":"right"},G=()=>{try{const t=localStorage.getItem("linmusic:last-playlist");if(!t)return;const e=JSON.parse(t);e!=null&&e.id&&(m.value={id:e.id,name:e.name})}catch{m.value=null}},N=t=>{m.value={id:t.id,name:t.name};try{localStorage.setItem("linmusic:last-playlist",JSON.stringify({id:t.id,name:t.name}))}catch{}},X=()=>{if(!m.value)return;const t=v.value.find(e=>{var l;return e.id===((l=m.value)==null?void 0:l.id)});if(t)m.value={id:t.id,name:t.name};else{m.value=null;try{localStorage.removeItem("linmusic:last-playlist")}catch{}}},Y=async()=>{v.value=await Pe(),X()},Z=()=>{S.value||(d&&(clearTimeout(d),d=null),f.value=!0,A())},ee=()=>{S.value||(d=setTimeout(()=>{f.value=!1},100))},te=()=>{d&&(clearTimeout(d),d=null),f.value=!f.value,f.value&&A()},se=async()=>{const t=await Se([{id:a.song.id,platform:a.song.platform}]);x.value=!!t[`${a.song.platform}-${a.song.id}`]},le=async()=>{if(!k.value&&(await Y(),await se(),await H(),b.value)){const t=b.value.getBoundingClientRect(),e=200,l=280;let n=t.right-e,i=t.bottom+4;n<8&&(n=8),i+l>window.innerHeight-8&&(i=t.top-l-4),j.value={top:`${i}px`,left:`${n}px`}}k.value=!k.value},w=()=>{k.value=!1,f.value=!1},ne=()=>{Q.addToPlaylist(a.song),w(),r.success("已添加到播放列表"),g("action","queue")},I=async(t,e)=>{if(!a.song.id){r.error("歌曲信息不完整，无法添加"),w();return}const l=await J(t,a.song);if(l.success){const n=v.value.find(T=>T.id===t),i=(n==null?void 0:n.name)||e;n?N(n):i&&N({id:t,name:i}),l.duplicated?r.info(i?`已在歌单中：${i}`:"已在歌单中"):i?r.success(`已添加到歌单：${i}`):r.success("已添加到歌单"),g("action","playlist"),window.dispatchEvent(new CustomEvent("linmusic-playlists-changed"))}else r.error(l.error||"添加失败");w()},ae=async()=>{const t=E.value;if(!t){r.error("暂无可用的上次歌单");return}await I(t.id)},ie=()=>{f.value=!1,C.value=!0,w()},O=async()=>{if(!h.value.trim())return;const t=await ge(h.value);if(t){v.value.unshift(t);const e=await J(t.id,a.song);e.success&&(N(t),e.duplicated?r.info(`已在歌单中：${t.name}`):r.success(`已创建并添加到歌单：${t.name}`),g("action","playlist"),window.dispatchEvent(new CustomEvent("linmusic-playlists-changed")))}h.value="",C.value=!1},oe=async()=>{x.value?await be(a.song.platform,a.song.id)&&(x.value=!1,r.success("已取消喜欢")):await ke(a.song)&&(x.value=!0,r.success("已添加到喜欢")),w(),g("action","like")},re=()=>{const t=Ce(a.song.id,a.song.platform,"320k");window.open(t,"_blank"),r.info("正在打开下载链接..."),w(),g("action","download")},V=t=>{const e=t.target;b.value&&b.value.contains(e)||$.value&&$.value.contains(e)||w()};return me(()=>{G(),document.addEventListener("click",V),u=window.matchMedia("(pointer: coarse)"),S.value=u.matches,u.addEventListener?u.addEventListener("change",L):u.addListener&&u.addListener(L)}),fe(()=>{document.removeEventListener("click",V),d&&clearTimeout(d),u&&(u.removeEventListener?u.removeEventListener("change",L):u.removeListener&&u.removeListener(L))}),(t,e)=>(c(),p("div",{class:"relative",ref_key:"menuRef",ref:b},[s("button",{class:M(["btn-icon text-white/30 hover:text-white transition-all duration-200",z.buttonClass]),onClick:y(le,["stop"])},[...e[4]||(e[4]=[s("span",{class:"material-symbols-outlined text-[20px]"},"more_horiz",-1)])],2),(c(),W(F,{to:"body"},[q(U,{name:"menu-fade"},{default:D(()=>[k.value?(c(),p("div",{key:0,class:"fixed z-[200]",style:pe(j.value)},[s("div",{ref_key:"menuPanelRef",ref:$,class:"bg-[#242424]/95 rounded-xl shadow-[0_12px_36px_rgba(0,0,0,0.5)] py-1 min-w-[220px] border border-white/10 backdrop-blur-md",onClick:e[0]||(e[0]=y(()=>{},["stop"]))},[s("button",{class:"menu-item w-full px-4 py-3 flex items-center gap-3 text-left text-white/80 hover:text-white hover:bg-white/10 transition-colors",onClick:ne},[...e[5]||(e[5]=[s("span",{class:"material-symbols-outlined text-[20px]"},"playlist_add",-1),s("span",{class:"text-sm font-medium"},"添加到播放列表",-1)])]),s("div",{class:"relative",onMouseenter:Z,onMouseleave:ee},[s("button",{class:"menu-item w-full px-4 py-3 flex items-center justify-between text-left text-white/80 hover:text-white hover:bg-white/10 transition-colors",ref_key:"playlistMenuItemRef",ref:B,onClick:y(te,["stop"])},[...e[6]||(e[6]=[s("div",{class:"flex items-center gap-3"},[s("span",{class:"material-symbols-outlined text-[20px]"},"library_add"),s("span",{class:"text-sm font-medium"},"添加到歌单")],-1),s("span",{class:"material-symbols-outlined text-[16px]"},"chevron_right",-1)])],512),f.value?(c(),p("div",{key:0,class:M(["mt-1 bg-[#1f1f1f]/95 rounded-xl shadow-[0_12px_28px_rgba(0,0,0,0.45)] py-1 w-full border border-white/10 z-[250] sm:absolute sm:top-0 sm:mt-0 sm:w-[200px]",_.value==="left"?"sm:right-full sm:mr-2":"sm:left-full sm:ml-2"])},[E.value?(c(),p("div",Le,[s("button",{class:"w-full flex items-center justify-between rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 px-3 py-2 transition-all",onClick:y(ae,["stop"])},[s("div",Te,[e[8]||(e[8]=s("span",{class:"material-symbols-outlined text-[18px] text-white/70"},"history",-1)),s("div",Me,[e[7]||(e[7]=s("span",{class:"text-xs text-white/60"},"最近歌单",-1)),s("span",$e,R(E.value.name),1)])]),e[9]||(e[9]=s("span",{class:"text-xs font-semibold text-primary whitespace-nowrap"},"一键添加",-1))])])):P("",!0),s("button",{class:"menu-item w-full px-4 py-3 flex items-center gap-3 text-left text-white/80 hover:text-white hover:bg-white/10 transition-colors border-b border-white/10",onClick:y(ie,["stop"])},[...e[10]||(e[10]=[s("span",{class:"material-symbols-outlined text-[20px]"},"add",-1),s("span",{class:"text-sm font-medium"},"新建歌单",-1)])]),s("div",Ee,[(c(!0),p(ve,null,xe(v.value,l=>(c(),p("button",{key:l.id,class:"menu-item w-full px-4 py-2.5 flex items-center gap-3 text-left text-white/80 hover:text-white hover:bg-white/10 transition-colors",onClick:y(n=>I(l.id,l.name),["stop"])},[e[11]||(e[11]=s("span",{class:"material-symbols-outlined text-[18px] text-white/50"},"queue_music",-1)),s("span",Re,R(l.name),1)],8,Ne))),128)),v.value.length===0?(c(),p("div",ze," 暂无歌单，请先创建 ")):P("",!0)])],2)):P("",!0)],32),e[13]||(e[13]=s("div",{class:"h-px bg-white/10 my-1"},null,-1)),s("button",{class:M(["menu-item w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-white/10 transition-colors",x.value?"text-primary":"text-white/80 hover:text-white"]),onClick:oe},[s("span",{class:M(["material-symbols-outlined text-[20px]",{"fill-1":x.value}])},"favorite",2),s("span",Be,R(x.value?"取消喜欢":"喜欢"),1)],2),s("button",{class:"menu-item w-full px-4 py-3 flex items-center gap-3 text-left text-white/80 hover:text-white hover:bg-white/10 transition-colors",onClick:re},[...e[12]||(e[12]=[s("span",{class:"material-symbols-outlined text-[20px]"},"download",-1),s("span",{class:"text-sm font-medium"},"下载",-1)])])],512)],4)):P("",!0)]),_:1})])),(c(),W(F,{to:"body"},[q(U,{name:"modal"},{default:D(()=>[C.value?(c(),p("div",je,[s("div",{class:"absolute inset-0 bg-black/70",onClick:e[1]||(e[1]=l=>C.value=!1)}),s("div",Ae,[e[14]||(e[14]=s("h2",{class:"text-xl font-bold text-white mb-4"},"新建歌单",-1)),we(s("input",{"onUpdate:modelValue":e[2]||(e[2]=l=>h.value=l),type:"text",class:"w-full h-12 px-4 rounded-md bg-white/10 border border-white/20 text-white placeholder-white/50 focus:outline-none focus:border-white/40 transition-colors",placeholder:"歌单名称",onKeyup:ye(O,["enter"])},null,544),[[he,h.value]]),s("div",Ie,[s("button",{class:"px-6 py-2 rounded-full text-white/70 hover:text-white font-medium transition-colors",onClick:e[3]||(e[3]=l=>C.value=!1)}," 取消 "),s("button",{class:"px-6 py-2 rounded-full bg-primary text-black font-bold hover:bg-[#1ed760] transition-colors",disabled:!h.value.trim(),onClick:O}," 创建并添加 ",8,Oe)])])])):P("",!0)]),_:1})]))],512))}}),qe=_e(Ve,[["__scopeId","data-v-633f8975"]]);export{qe as S};
